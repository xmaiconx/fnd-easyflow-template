# Test Results - Internal Auth + Admin Panel

Execução de testes de API para a feature F0001-internal-auth-admin-panel.

**Executado:** 2025-12-20 04:04:32
**Resultado:** 2/8 testes passaram
**Status:** FAILED

---

## Spec (Token-Efficient)

{"execution":{"timestamp":"2025-12-20T04:04:32Z","duration_ms":521,"feature":"F0001-internal-auth-admin-panel","infrastructure":"isolated","db":"fnd_easyflow_test","backend_port":3099,"db_port":5433}}
{"summary":{"total":8,"passed":2,"failed":6,"requests_executed":11}}
{"passed":["00-setup.hurl","03-auth-password-reset.hurl"]}
{"failed":[{"test":"01-auth-signup-signin.hurl","reason":"rate_limit","entry":4,"expected":"status==400","actual":"status==429"},{"test":"02-auth-sessions.hurl","reason":"missing_variable","variable":"accessToken"},{"test":"04-auth-email-verification.hurl","reason":"rate_limit","entry":1,"expected":"status==201","actual":"status==429"},{"test":"05-manager-users.hurl","reason":"missing_variable","variable":"superAdminAccessToken"},{"test":"06-manager-impersonate.hurl","reason":"missing_variable","variable":"superAdminAccessToken"},{"test":"07-manager-metrics.hurl","reason":"missing_variable","variable":"superAdminAccessToken"}]}
{"issues":{"infrastructure":["rate_limit_too_aggressive","hurl_no_cross_file_variables"],"functionality":["rate_limit_blocks_validation"]}}

---

## Detalhes das Falhas

### 01-auth-signup-signin.hurl (FUNCIONALIDADE)

**Tipo:** Rate Limit Bloqueando Validação
**Entry:** 4 de 6
**Endpoint:** POST /auth/signup
**Esperado:** HTTP 400 (validação de senha fraca "weak")
**Recebido:** HTTP 429 Too Many Requests

**Payload:**
```json
{
  "email": "weak@example.com",
  "password": "weak",
  "name": "Test User",
  "workspaceName": "Test Workspace"
}
```

**Response recebida:**
```json
{ "message": "Too many requests" }
```

**Contexto para /fix:**
- **Problema:** O rate limiter está bloqueando a 4ª requisição consecutiva antes que a validação de senha seja executada
- **Comportamento esperado:** A validação de DTO (senha fraca) deveria ocorrer ANTES do rate limit, retornando 400 Bad Request
- **Ordem correta:** Validação de DTO → Rate Limit → Lógica de negócio
- **Arquivo provável:** [apps/backend/src/api/modules/auth/auth.controller.ts](apps/backend/src/api/modules/auth/auth.controller.ts)
- **Guard provável:** [apps/backend/src/api/guards/rate-limit.guard.ts](apps/backend/src/api/guards/rate-limit.guard.ts)
- **Solução sugerida:** Aplicar rate limit APÓS validação de DTO, ou aumentar limite para testes automatizados

**Output completo:** `01-auth-signup-signin-result.txt` (linha 157)

---

### 02-auth-sessions.hurl (INFRAESTRUTURA)

**Tipo:** Variável não compartilhada entre arquivos Hurl
**Variável faltando:** `accessToken`
**Capturada em:** 01-auth-signup-signin.hurl (entry 1)
**Necessária em:** 02-auth-sessions.hurl (entry 1, linha 18)

**Erro:**
```
error: Undefined variable
   --> 02-auth-sessions.hurl:18:25
    | Authorization: Bearer {{accessToken}}
    |                         ^^^^^^^^^^^ you must set the variable accessToken
```

**Contexto:**
- O Hurl não compartilha variáveis entre arquivos, mesmo em modo sequencial (`--jobs 1`)
- Testes foram escritos assumindo compartilhamento de variáveis entre arquivos
- **Não é um bug do código**, é uma limitação do runner de testes

**Soluções possíveis:**
1. Consolidar testes dependentes em arquivo único
2. Cada arquivo faz seu próprio setup (signin) antes dos testes
3. Usar `--variables-file` com variáveis pré-definidas (não funciona para tokens dinâmicos)

---

### 04-auth-email-verification.hurl (FUNCIONALIDADE)

**Tipo:** Rate Limit bloqueando signup legítimo
**Entry:** 1 de 3
**Endpoint:** POST /auth/signup
**Esperado:** HTTP 201 Created
**Recebido:** HTTP 429 Too Many Requests

**Payload:**
```json
{
  "email": "verify@example.com",
  "password": "Password123!",
  "name": "Verify User",
  "workspaceName": "Verify Workspace"
}
```

**Contexto para /fix:**
- Mesmo problema do teste 01 - rate limit muito agressivo
- Testes automatizados executam múltiplos signups em sequência rápida
- Rate limit deveria ser por email/usuário, não global/IP
- Ou aumentar limite para ambiente de teste

---

### 05-manager-users.hurl (INFRAESTRUTURA)

**Tipo:** Variável não compartilhada entre arquivos Hurl
**Variável faltando:** `superAdminAccessToken`
**Capturada em:** 00-setup.hurl (entry 2)
**Necessária em:** 05-manager-users.hurl (entry 1, linha 16)

**Mesmo problema do teste 02** - limitação do Hurl, não do código.

---

### 06-manager-impersonate.hurl (INFRAESTRUTURA)

**Tipo:** Variável não compartilhada entre arquivos Hurl
**Variável faltando:** `superAdminAccessToken`
**Capturada em:** 00-setup.hurl (entry 2)
**Necessária em:** 06-manager-impersonate.hurl (entry 1, linha 16)

**Mesmo problema do teste 02** - limitação do Hurl, não do código.

---

### 07-manager-metrics.hurl (INFRAESTRUTURA)

**Tipo:** Variável não compartilhada entre arquivos Hurl
**Variável faltando:** `superAdminAccessToken`
**Capturada em:** 00-setup.hurl (entry 2)
**Necessária em:** 07-manager-metrics.hurl (entry 1, linha 16)

**Mesmo problema do teste 02** - limitação do Hurl, não do código.

---

## Testes Passando

- [x] **00-setup.hurl** - Setup inicial + Super admin signin (2 requests, 117ms)
  - Entry 1: GET / → 200 OK (health check)
  - Entry 2: POST /auth/signin → 200 OK (super admin login)
  - Capturou: superAdminAccessToken, superAdminRefreshToken, superAdminUserId

- [x] **03-auth-password-reset.hurl** - Fluxo de recuperação de senha (4 requests, 23ms)
  - Entry 1: POST /auth/forgot-password (email válido) → 200 OK
  - Entry 2: POST /auth/forgot-password (email inexistente) → 200 OK (não revela se email existe)
  - Entry 3: POST /auth/forgot-password (email inválido) → 400 Bad Request
  - Entry 4: POST /auth/reset-password (token inválido) → 400 Bad Request

---

## Resumo de Problemas

### Problemas de Funcionalidade (requerem /fix)

1. **Rate Limit Bloqueando Validação (CRÍTICO)**
   - **Impacto:** Validações de DTO não são executadas quando rate limit é atingido
   - **Testes afetados:** 01-auth-signup-signin.hurl (entry 4), 04-auth-email-verification.hurl (entry 1)
   - **Solução:** Reordenar middlewares - validação ANTES de rate limit
   - **Arquivos:**
     - [apps/backend/src/api/modules/auth/auth.controller.ts](apps/backend/src/api/modules/auth/auth.controller.ts)
     - [apps/backend/src/api/guards/rate-limit.guard.ts](apps/backend/src/api/guards/rate-limit.guard.ts)

2. **Rate Limit Muito Agressivo**
   - **Impacto:** Testes automatizados não conseguem executar múltiplos signups em sequência
   - **Sugestão:**
     - Aumentar limite em ambiente de teste (detectar via NODE_ENV)
     - OU aplicar rate limit por email/usuário, não global/IP
     - OU adicionar whitelist de IPs para testes (localhost)

### Problemas de Infraestrutura (design de testes)

3. **Variáveis Não Compartilhadas Entre Arquivos Hurl**
   - **Impacto:** 4 de 8 testes falham por dependência de variáveis
   - **Testes afetados:** 02, 05, 06, 07
   - **Causa:** Limitação do Hurl - variáveis são isoladas por arquivo
   - **Soluções:**
     - **Opção 1 (recomendada):** Consolidar testes relacionados em arquivos únicos
       - `auth-complete.hurl` com signup + signin + sessions
       - `manager-complete.hurl` com setup + users + impersonate + metrics
     - **Opção 2:** Cada arquivo faz seu próprio setup (signin) antes dos testes
     - **Opção 3:** Usar script wrapper que extrai variáveis e injeta via `--variable`

---

## Recomendações

### Para Corrigir Agora (/fix)

1. **Corrigir ordem de middlewares** no AuthController
   - Validação DTO deve vir ANTES do rate limit guard
   - Garantir que erros de validação (400) têm prioridade sobre rate limit (429)

2. **Ajustar configuração de rate limit** para ambiente de teste
   - Aumentar limite quando `NODE_ENV=test` ou `LOG_LEVEL=warn`
   - OU desabilitar rate limit em localhost
   - OU aplicar por email/usuário em vez de global/IP

### Para Melhorar Depois

3. **Reestruturar arquivos de teste Hurl**
   - Consolidar testes dependentes em arquivos únicos
   - Adicionar setup próprio em cada arquivo (menos eficiente, mas funciona)
   - Documentar limitação do Hurl no README dos testes

4. **Considerar alternativa ao Hurl**
   - Se compartilhamento de variáveis for crítico, avaliar:
     - REST Client (VS Code extension) - suporta variáveis globais
     - Postman/Newman - suporta environments
     - Playwright para testes de API - JavaScript completo

---

## Conclusão

**Status Geral:** FAILED (2/8 testes passaram)

**Problemas Críticos Encontrados:**
1. Rate limit está bloqueando validações de DTO (precisa correção urgente)
2. Rate limit muito agressivo para testes automatizados
3. Arquitetura de testes não compatível com limitações do Hurl

**Próximos Passos:**
1. Executar `/fix` referenciando este relatório para corrigir rate limit
2. Após correção, executar `/test-api` novamente para validar
3. Avaliar reestruturação dos arquivos de teste para eliminar dependência de variáveis cross-file

**Infraestrutura de Testes:** Funcionando corretamente
- Docker containers isolados (PostgreSQL:5433, Redis:6380) ✅
- Migrations aplicadas com sucesso ✅
- Super admin criado (admin@fnd.dev) ✅
- Backend respondendo em porta 3099 ✅

**Funcionalidades Validadas:**
- Health check ✅
- Super admin signin ✅
- Fluxo completo de password reset ✅
- Signup de usuário (parcialmente - bloqueado por rate limit após 3 requisições)
