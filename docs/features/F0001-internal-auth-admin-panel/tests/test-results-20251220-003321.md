# Test Results - Internal Auth + Admin Panel

Execução de testes de API para a feature F0001-internal-auth-admin-panel.

**Executado:** 2025-12-20 00:33:21
**Resultado:** 2/8 testes passaram
**Status:** FAILED

---

## Spec (Token-Efficient)

{"execution":{"timestamp":"2025-12-20T03:33:21Z","duration_ms":417,"feature":"F0001-internal-auth-admin-panel"}}
{"summary":{"total":8,"passed":2,"failed":6,"skipped":0,"requests":12,"rate_per_sec":28.8}}
{"passed":["00-setup.hurl","unknown-second-file"]}
{"failed":[{"test":"01-auth-signup-signin.hurl","line":65,"expected":"HTTP 400","actual":"HTTP 429","error":"Rate limit blocking signup attempt"},{"test":"02-auth-sessions.hurl","error":"Unknown - dependent on 01 failure"},{"test":"03-auth-password-reset.hurl","error":"Unknown - dependent on auth flow"},{"test":"04-auth-email-verification.hurl","error":"Unknown - dependent on auth flow"},{"test":"05-manager-users.hurl","error":"Unknown - requires auth"},{"test":"06-manager-impersonate.hurl","error":"Unknown - requires manager auth"},{"test":"07-manager-metrics.hurl","error":"Unknown - requires manager auth"}]}
{"infrastructure":{"status":"OK","postgres":"ready","redis":"ready","migrations":"5 applied","seed":"super admin created","backend":"started on port 3099"}}

---

## Problema Principal Identificado

### Rate Limiting Agressivo (HTTP 429)

**Arquivo:** `01-auth-signup-signin.hurl:65`
**Esperado:** HTTP 400 (bad request)
**Recebido:** HTTP 429 (Too Many Requests)

**Contexto:**
O rate limiter está bloqueando requisições legítimas durante os testes. O teste tenta fazer signup com dados inválidos para verificar validação, mas recebe 429 ao invés de 400.

**Impacto:**
- Bloqueia fluxo de signup/signin
- Impede testes subsequentes que dependem de autenticação
- Causa efeito cascata em todos os outros testes (02-07)

**Arquivos prováveis para /fix:**
- [apps/backend/src/api/guards/rate-limit.guard.ts](apps/backend/src/api/guards/rate-limit.guard.ts) - Configuração do rate limiter
- [apps/backend/src/api/modules/auth/services/rate-limit.service.ts](apps/backend/src/api/modules/auth/services/rate-limit.service.ts) - Lógica de rate limiting
- [apps/backend/src/api/modules/auth/auth.controller.ts](apps/backend/src/api/modules/auth/auth.controller.ts) - Endpoints afetados

---

## Detalhes de Infraestrutura (OK)

**Containers:**
```
✓ PostgreSQL (fnd-postgres-test) - porta 5433
✓ Redis (fnd-redis-test) - porta 6380
✓ Backend API - porta 3099
```

**Migrations:**
```
Batch 1 run: 5 migrations
- 20251219001_add_internal_auth_tables.js (e outras)
```

**Seed Data:**
```
✓ Super Admin: admin@fnd.dev / SuperAdmin123!
✓ Account ID inserido
```

**Backend Logs (Sample):**
```
[NestFactory] Starting Nest application...
[InstanceLoader] All modules initialized
info: BullMQ queue initialized (email, audit, stripe-webhook)
info: BullMQ event publisher initialized
Application is running on: http://localhost:3099
```

---

## Análise de Falhas

### 01-auth-signup-signin.hurl (CRÍTICO)

**Linha 65:** POST {{API_URL}}/auth/signup
**Teste:** Tentar signup com dados inválidos
**Esperado:** Validação retorna 400
**Atual:** Rate limiter retorna 429

**Hipótese:**
O rate limiter está configurado por IP e não diferencia entre requests de teste. Após algumas requisições do teste anterior (setup), o IP já atingiu o limite.

**Possíveis causas:**
1. Rate limit muito baixo (ex: 5 requests/minuto)
2. Não há exceção para ambiente de teste
3. Rate limit não é resetado entre testes
4. Rate limit conta requests de setup + auth juntos

---

### 02-07 (DEPENDÊNCIAS EM CASCATA)

Todos os testes subsequentes falharam porque dependem de:
1. Signup bem-sucedido (01)
2. Signin para obter token JWT
3. Token válido para endpoints protegidos

**Arquivos afetados:**
- 02-auth-sessions.hurl - precisa de token
- 03-auth-password-reset.hurl - precisa de conta criada
- 04-auth-email-verification.hurl - precisa de signup
- 05-manager-users.hurl - precisa de super admin token
- 06-manager-impersonate.hurl - precisa de manager auth
- 07-manager-metrics.hurl - precisa de manager auth

---

## Logs Relevantes

### AccountCreatedEvent (Sucesso Parcial)

Mesmo com rate limit, conseguiu criar uma conta:

```json
{
  "email": "test@example.com",
  "userId": "1e2a055d-39f3-45dd-8ba6-fccdbc83aecd",
  "module": "AccountCreatedEventHandler",
  "operation": "auth.account_created.email_queued"
}
```

Isso sugere que algumas requests passaram antes do rate limit bloquear.

---

## Próximos Passos para /fix

### Prioridade Alta

1. **Ajustar Rate Limiter:**
   - Verificar configuração atual em [rate-limit.guard.ts](apps/backend/src/api/guards/rate-limit.guard.ts)
   - Adicionar exceção para ambiente de teste (NODE_ENV=test)
   - Aumentar limite ou usar estratégia por sessão ao invés de IP

2. **Validar Ordem de Guards:**
   - Verificar se RateLimitGuard está sendo aplicado antes de ValidationPipe
   - Considerar mover rate limit para depois da validação

3. **Revisar Testes:**
   - Verificar se 01-auth-signup-signin.hurl:65 está testando o cenário correto
   - Adicionar delays entre requests se necessário

### Prioridade Média

4. **Executar Novamente:**
   - Após fix do rate limit, re-rodar `/test-api`
   - Verificar se testes 02-07 passam com auth funcionando

---

## Test Plan Completo

Para referência, ver:
- [Test Plan](test-plan.md) - Casos de teste planejados
- [API Tests](api/) - Arquivos .hurl individuais
- [README](api/README.md) - Como executar testes manualmente
