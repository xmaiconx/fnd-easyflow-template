# Test Results - F0001-internal-auth-admin-panel

Execucao de testes de API para a feature F0001-internal-auth-admin-panel.

**Executado:** 2025-12-21 01:47:00 UTC
**Resultado:** 6/8 testes passaram
**Status:** FAILED

---

## Spec (Token-Efficient)

{"execution":{"timestamp":"2025-12-21T01:47:00Z","duration_ms":360000,"feature":"F0001-internal-auth-admin-panel"}}
{"summary":{"total":8,"passed":6,"failed":2}}
{"passed":["00-setup.hurl","01-auth-signup-signin.hurl","02-auth-sessions.hurl","03-auth-password-reset.hurl","04-auth-email-verification.hurl","07-manager-metrics.hurl"]}
{"failed":[{"test":"05-manager-users.hurl","entry":6,"expected":"status==204","actual":"status==400","response":{"message":"status must be one of the following values: active, archived, deleted","error":"Bad Request","statusCode":400}},{"test":"06-manager-impersonate.hurl","entry":1,"expected":"status==200","actual":"status==500","response":{"statusCode":500,"message":"Internal server error"}}]}

---

## Detalhes das Falhas

### 05-manager-users.hurl (Entry 6)

**Endpoint:** PATCH /api/v1/manager/users/:id/status

**Esperado:** HTTP 204 (atualizar status para `inactive`)
**Recebido:** HTTP 400 Bad Request

**Response:**
```json
{
  "message": ["status must be one of the following values: active, archived, deleted"],
  "error": "Bad Request",
  "statusCode": 400
}
```

**Analise:**
O enum `EntityStatus` no CLAUDE.md define `active|inactive|deleted`, mas a validacao do DTO (`UpdateUserStatusDto`) aceita `active|archived|deleted`. Ha um mismatch entre o enum de dominio e a validacao do DTO.

**Contexto para /fix:**
- O teste tenta usar `status: inactive` mas a API so aceita `active, archived, deleted`
- Arquivos relevantes:
  - [UpdateUserStatusDto.ts](apps/backend/src/api/modules/manager/dtos/UpdateUserStatusDto.ts)
  - [EntityStatus enum](libs/domain/src/enums/EntityStatus.ts)
- Opcoes de correcao:
  1. Atualizar o DTO para aceitar `inactive` (alinhar com EntityStatus)
  2. Atualizar o teste para usar `archived` ao inves de `inactive`
  3. Verificar se `archived` e `inactive` sao sinonimos e padronizar

---

### 06-manager-impersonate.hurl (Entry 1)

**Endpoint:** POST /api/v1/manager/impersonate

**Esperado:** HTTP 200 (iniciar impersonation)
**Recebido:** HTTP 500 Internal Server Error

**Response:**
```json
{
  "statusCode": 500,
  "message": "Internal server error"
}
```

**Analise:**
O endpoint de impersonation esta retornando um erro interno do servidor. Isso indica um bug no handler `ImpersonateCommandHandler` ou no servico de impersonation.

**Contexto para /fix:**
- Endpoint: POST /api/v1/manager/impersonate
- Body enviado: `{"targetUserId": "...", "reason": "Testing impersonation feature for QA purposes"}`
- Arquivos relevantes:
  - [manager.controller.ts](apps/backend/src/api/modules/manager/manager.controller.ts)
  - [ImpersonateCommand.ts](apps/backend/src/api/modules/manager/commands/ImpersonateCommand.ts)
  - [ImpersonateCommandHandler.ts](apps/backend/src/api/modules/manager/commands/handlers/ImpersonateCommandHandler.ts)
  - [manager.service.ts](apps/backend/src/api/modules/manager/manager.service.ts)
- Verificar logs do backend para stack trace completo
- Possiveis causas:
  1. Erro ao criar sessao de impersonation no banco
  2. Erro ao gerar token JWT para impersonation
  3. Dependencia nao injetada corretamente

---

## Testes Passando

- [x] **00-setup.hurl** - Health check + Super Admin auth (2 entries, ~80ms)
- [x] **01-auth-signup-signin.hurl** - Signup, signin, profile (10 entries, ~500ms)
- [x] **02-auth-sessions.hurl** - Session management, multi-device (20+ entries)
- [x] **03-auth-password-reset.hurl** - Password reset flow (4 entries, ~35ms)
- [x] **04-auth-email-verification.hurl** - Email verification (4 entries, ~100ms)
- [x] **07-manager-metrics.hurl** - Metrics dashboard (3 entries, ~40ms)

---

## Resumo das Falhas

| Teste | Tipo de Erro | Severidade | Acao |
|-------|--------------|------------|------|
| 05-manager-users.hurl | Validacao/Enum mismatch | Media | Alinhar DTO com EntityStatus ou atualizar teste |
| 06-manager-impersonate.hurl | Bug interno (500) | Alta | Investigar logs e corrigir handler |

---

## Proximos Passos

1. Execute `/fix` referenciando este relatorio para corrigir as falhas
2. Verifique os logs do backend para obter o stack trace do erro 500
3. Apos correcoes, execute `/test-api` novamente para validar
